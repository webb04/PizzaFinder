"use strict";!function(){function t(t){return Array.prototype.slice.call(t)}function n(t){return new Promise(function(n,e){t.onsuccess=function(){n(t.result)},t.onerror=function(){e(t.error)}})}function e(t,e,o){var i,r=new Promise(function(r,a){i=t[e].apply(t,o),n(i).then(r,a)});return r.request=i,r}function o(t,n,o){var i=e(t,n,o);return i.then(function(t){if(t)return new u(t,i.request)})}function i(t,n,e){e.forEach(function(e){Object.defineProperty(t.prototype,e,{get:function(){return this[n][e]}})})}function r(t,n,o,i){i.forEach(function(i){i in o.prototype&&(t.prototype[i]=function(){return e(this[n],i,arguments)})})}function a(t,n,e,o){o.forEach(function(o){o in e.prototype&&(t.prototype[o]=function(){return this[n][o].apply(this[n],arguments)})})}function c(t,n,e,i){i.forEach(function(i){i in e.prototype&&(t.prototype[i]=function(){return o(this[n],i,arguments)})})}function s(t){this._index=t}function u(t,n){this._cursor=t,this._request=n}function l(t){this._store=t}function p(t){this._tx=t,this.complete=new Promise(function(n,e){t.oncomplete=function(){n()},t.onerror=function(){e(t.error)}})}function d(t,n,e){this._db=t,this.oldVersion=n,this.transaction=new p(e)}function f(t){this._db=t}i(s,"_index",["name","keyPath","multiEntry","unique"]),r(s,"_index",IDBIndex,["get","getKey","getAll","getAllKeys","count"]),c(s,"_index",IDBIndex,["openCursor","openKeyCursor"]),i(u,"_cursor",["direction","key","primaryKey","value"]),r(u,"_cursor",IDBCursor,["update","delete"]),["advance","continue","continuePrimaryKey"].forEach(function(t){t in IDBCursor.prototype&&(u.prototype[t]=function(){var e=this,o=arguments;return Promise.resolve().then(function(){return e._cursor[t].apply(e._cursor,o),n(e._request).then(function(t){if(t)return new u(t,e._request)})})})}),l.prototype.createIndex=function(){return new s(this._store.createIndex.apply(this._store,arguments))},l.prototype.index=function(){return new s(this._store.index.apply(this._store,arguments))},i(l,"_store",["name","keyPath","indexNames","autoIncrement"]),r(l,"_store",IDBObjectStore,["put","add","delete","clear","get","getAll","getAllKeys","count"]),c(l,"_store",IDBObjectStore,["openCursor","openKeyCursor"]),a(l,"_store",IDBObjectStore,["deleteIndex"]),p.prototype.objectStore=function(){return new l(this._tx.objectStore.apply(this._tx,arguments))},i(p,"_tx",["objectStoreNames","mode"]),a(p,"_tx",IDBTransaction,["abort"]),d.prototype.createObjectStore=function(){return new l(this._db.createObjectStore.apply(this._db,arguments))},i(d,"_db",["name","version","objectStoreNames"]),a(d,"_db",IDBDatabase,["deleteObjectStore","close"]),f.prototype.transaction=function(){return new p(this._db.transaction.apply(this._db,arguments))},i(f,"_db",["name","version","objectStoreNames"]),a(f,"_db",IDBDatabase,["close"]),["openCursor","openKeyCursor"].forEach(function(n){[l,s].forEach(function(e){e.prototype[n.replace("open","iterate")]=function(){var e=t(arguments),o=e[e.length-1],i=(this._store||this._index)[n].apply(this._store,e.slice(0,-1));i.onsuccess=function(){o(i.result)}}})}),[s,l].forEach(function(t){t.prototype.getAll||(t.prototype.getAll=function(t,n){var e=this,o=[];return new Promise(function(i){e.iterateCursor(t,function(t){return t?(o.push(t.value),void 0!==n&&o.length==n?void i(o):void t["continue"]()):void i(o)})})})});var h={open:function(t,n,o){var i=e(indexedDB,"open",[t,n]),r=i.request;return r.onupgradeneeded=function(t){o&&o(new d(r.result,t.oldVersion,r.transaction))},i.then(function(t){return new f(t)})},"delete":function(t){return e(indexedDB,"deleteDatabase",[t])}};"undefined"!=typeof module?module.exports=h:self.idb=h}();var offlineMode=!1,positionArray=[],locationRetrieved=!1;$(document).ready(function(){getLocation()}),$(".pizza-button").on("click",function(){locationRetrieved&&($("#pizza-container").addClass("pizza-spin"),$(".pizza-button").html("Finding Pizza"),fetch("https://api.foursquare.com/v2/venues/search?ll="+positionArray[0]+","+positionArray[1]+"&client_id=KAKRJKH45UMDES3SUEMEJYHZOBANXSGK1XRMHHNROGGLXCPF&client_secret=LPO0YOEHQ0NOGJPCPWZQSRQWGY1SE4I4SCO22DSEVSH0W0E4&v=20161105&query=pizza&radius=10000&limit=5").then(function(t){return t.json()}).then(function(t){window.setTimeout(function(){$("#pizza-container").removeClass("pizza-spin"),$(".pizza-button").html("Find me a pizza")},3800),$("#pizza-locations").html("");var n=t.response.venues;n.sort(function(t,n){return t.location.distance-n.location.distance}),n.map(function(t){var n="";t.location.formattedAddress.map(function(t){return n+=t+", "}),n=n.substring(0,n.length-2),$("#pizza-locations").append("<div class='location'><div class=\"location-name\">"+t.name+" - "+t.location.distance+" metres away</div><div>"+n+"</div></div>")}),storeInIDB(n)})["catch"](function(t){showOfflineState()}))});var showOfflineState=function(){document.getElementById("title").innerHTML="<span id='offline'>Offline (Distances may be inaccurate)</span> - Pizza Finder",offlineMode=!0,console.log("There has been a problem with your fetch operation: ");var t=idb.open("pizza-locations",1,function(t){});t.then(function(t){return t.transaction("locations").objectStore("locations").getAll()}).then(function(t){window.setTimeout(function(){$("#pizza-container").removeClass("pizza-spin"),$(".pizza-button").html("Unable to determine location")},3800),t[0].locations.map(function(t){var n="";t.location.formattedAddress.map(function(t){return n+=t+", "}),n=n.substring(0,n.length-2),$("#pizza-locations").append("<div class='location'><div class=\"location-name\">"+t.name+" - "+t.location.distance+" metres away</div><div>"+n+"</div></div>")})})},getLocation=function(){window.setTimeout(function(){positionArray.length<2&&(showOfflineState(),$(".pizza-button").html("Unable to determine location"))},5e3),navigator.geolocation?navigator.geolocation.getCurrentPosition(showPosition):console.log("Geolocation is not supported by this browser.")},showPosition=function(t){positionArray.push(t.coords.latitude),positionArray.push(t.coords.longitude),locationRetrieved=!0,$(".pizza-button").html("Find me a Pizza")},storeInIDB=function(t){var n=idb.open("pizza-locations",1,function(t){t.createObjectStore("locations",{keyPath:"name"})});n.then(function(n){var e=n.transaction("locations","readwrite"),o=e.objectStore("locations");return o.put({name:"1",locations:t}),e.complete}).then(function(){console.log("locations added")})};